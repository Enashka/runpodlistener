# ComfyUI Image Sync Tool
*Maintained by Enashka*

A simple tool to automatically sync images generated by ComfyUI on RunPod to Google Drive.

## Features

- Monitors the ComfyUI output directory for new images
- Automatically uploads new images to a specified Google Drive folder
- Only syncs files created after the tool starts running
- Runs in the background as a service
- Simple installation and setup
- Configurable via config.yaml file
- Leverages RunPod's persistent storage to maintain configuration between pod restarts

## Installation on RunPod

### Prerequisites

1. A Google Cloud project with the Google Drive API enabled
2. OAuth 2.0 credentials (credentials.json) for the Google Drive API
3. A Google Drive folder ID where images will be uploaded

### Quick Setup (Recommended)

For a simplified setup process, you can use our setup script:

1. Connect to your RunPod instance via SSH or the web terminal

2. If you're updating from a previous version or restarting, first stop any existing sync service:
   ```bash
   pkill -f minimal_sync.py
   ```

3. Download and run the setup script:
   ```bash
   curl -O https://raw.githubusercontent.com/Enashka/runpodlistener/main/setup_sync.sh
   chmod +x setup_sync.sh
   ./setup_sync.sh
   ```

4. Follow the prompts if needed:
   - Enter your Google Drive folder ID when asked (only on first setup)
   - Upload your credentials.json file when prompted (only if not already present)
   - Complete the Google authentication process (only on first authentication)

   > **Important**: When downloading credentials from Google Cloud Console, the file might be named something like "client_secret_XXXX.json". Make sure to rename it to exactly "credentials.json" before uploading.

5. Start the sync service:
   ```bash
   ./start.sh
   ```

The setup script will:
- Check if files already exist in persistent storage
- Download only missing files
- Install dependencies
- Use existing configuration if available
- Guide you through authentication if needed
- Provide instructions for starting the service

**Note**: Since RunPod's `/workspace` directory is persistent, your configuration and authentication will be preserved between pod restarts. When you restart your pod, simply run the setup script again, and it will detect your existing configuration.

## How It Works

The sync tool monitors the ComfyUI output directory for new image files created after the tool starts running. It does not check or upload existing files that were created before the tool was started. This ensures:

1. Fast startup - The tool begins monitoring immediately without scanning existing files
2. No duplicate uploads - Only new images generated by ComfyUI will be uploaded
3. Efficient operation - The tool only processes files that are actually new

Each time you start the tool, it records the current time and only processes files with creation timestamps newer than this start time.

### Manual Installation Steps

If you prefer to install manually, follow these steps:

1. Connect to your RunPod instance via SSH or the web terminal

2. Create a directory for the sync tool:
   ```bash
   mkdir -p /workspace/runpodlistener
   cd /workspace/runpodlistener
   ```

3. Download the sync script:
   ```bash
   curl -O https://raw.githubusercontent.com/Enashka/runpodlistener/main/minimal_sync.py
   chmod +x minimal_sync.py
   ```

4. Download the configuration file:
   ```bash
   curl -O https://raw.githubusercontent.com/Enashka/runpodlistener/main/config.yaml
   ```

5. Install dependencies:
   ```bash
   pip install pydrive2 python-dotenv pyyaml
   ```

6. Upload your credentials.json file to this directory (you can use the RunPod file browser)

   > **Important**: When downloading credentials from Google Cloud Console, the file might be named something like "client_secret_XXXX.json". Make sure to rename it to exactly "credentials.json" before uploading.

7. Edit the config.yaml file to set your Google Drive folder ID:
   ```bash
   # Replace YOUR_FOLDER_ID with your actual Google Drive folder ID
   sed -i 's/YOUR_FOLDER_ID/your_actual_folder_id/' config.yaml
   ```

8. Run the script once to authenticate:
   ```bash
   python minimal_sync.py --once
   ```
   
   Follow the authentication link provided, sign in with your Google account, and paste the verification code back into the terminal.

9. Create a start script:
   ```bash
   curl -O https://raw.githubusercontent.com/Enashka/runpodlistener/main/start.sh
   chmod +x start.sh
   ```

10. Start the sync service:
    ```bash
    ./start.sh
    ```

## Restarting After Pod Shutdown

When you restart your RunPod instance, your configuration will be preserved in the persistent `/workspace` directory. To restart the sync service:

1. Connect to your RunPod instance via SSH or the web terminal

2. Stop any existing sync service:
   ```bash
   pkill -f minimal_sync.py
   ```

3. Run the setup script:
   ```bash
   cd /workspace/runpodlistener
   ./setup_sync.sh
   ```

4. Start the sync service:
   ```bash
   ./start.sh
   ```

The script will detect your existing configuration and authentication, and ensure everything is set up correctly before you start the service.

## Configuration

The tool can be configured by editing the `config.yaml` file:

```yaml
# Google Drive folder ID where images will be uploaded
folder_id: "YOUR_FOLDER_ID"

# Sync interval in seconds
sync_interval: 5  # Check for new files every 5 seconds

# ComfyUI output directory
output_directory: "/workspace/ComfyUI/output"

# File extensions to sync
file_extensions:
  - ".png"
  - ".jpg"
  - ".jpeg"
```

You can modify these settings to change:
- The Google Drive folder where images are uploaded
- How frequently the tool checks for new files
- Which directory to monitor for new images
- Which file extensions to sync

## Usage

The sync tool will run in the background and automatically upload new images from the ComfyUI output directory to your specified Google Drive folder.

To check the logs:
```bash
tail -f sync.log
```

To stop the service:
```bash
pkill -f minimal_sync.py
```

To restart the service:
```bash
pkill -f minimal_sync.py
./start.sh
```

## Getting Your Google Drive Folder ID

1. Navigate to the folder in Google Drive where you want to upload images
2. The folder ID is the last part of the URL:
   ```
   https://drive.google.com/drive/folders/YOUR_FOLDER_ID
   ```

## Getting Google Drive API Credentials

1. Go to the [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select an existing one
3. Enable the Google Drive API
4. Create OAuth 2.0 credentials (Desktop application)
5. Download the credentials.json file (if the downloaded file has a different name like "client_secret_XXXX.json", rename it to "credentials.json")

## License

[MIT License](LICENSE)

